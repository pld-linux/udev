#!/bin/sh
MAX_LOOPS=1024
UDEV_RULES_FILE=/etc/udev/rules.d/60-persistent-${SUBSYSTEM}.rules

already_exists() {
    echo $EXISTING | grep -q "\b$1\b"
}

add_result() {
    if [ -z "$RESULTS" ]; then
	RESULTS=$1
    else
	RESULTS="$RESULTS $1"
    fi
}

add_first_available() {
    BASE=$1
    [ -z "$ADD" ] || already_exists $BASE || add_result $BASE
    i=0
    while [ $MAX_LOOPS -gt $i ] && already_exists "$BASE$i"; do
	: $((i++))
    done
    add_result "$BASE$i"
}

write_rule() {
    MATCH=$1
    echo "SUBSYSTEM==\"$SUBSYSTEM\", ACTION==\"add\", $MATCH, $TARGET$ADD=\"$RESULTS\", ENV{GENERATED}=\"yes\"" >> $UDEV_RULES_FILE
}

read_rules() {
    if [ ! -f $UDEV_RULES_FILE ]; then
        cat > $UDEV_RULES_FILE <<EOF
# autogenerated udev persistent rules for $SUBSYSTEM subsystem
#
EOF
    fi
    EXISTING=`sed -ne "/^[[:space:]]*#.*/b; s/.*$TARGET$ADD=\"\([^\"]*\)\".*/\1/; T; p" $UDEV_RULES_FILE | sort -u`
}
